services:
  watchtower:
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - "--label-enable"
      - "--interval"
      - "30"
      - "--rolling-restart"
    networks:
      - ext

  postgres:
    image: postgres:16
    labels:
      # loadbalancer
      - "traefik.enable=true"
      # watchtower
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      - POSTGRES_USER=main
      - POSTGRES_DB=wallet
      # secrets
      - POSTGRES_PASSWORD=${POSTGRES_DB_PASSWORD}
    restart: on-failure
    volumes:
      - postgresdata:/var/lib/postgresql/data
    networks:
      - ext


  backend:
    image: pavelbeard/wallet-backend.production:latest
    labels:
      # loadbalancer
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`cartera.heavycream.es`) && (PathPrefix(`/api-v1`) || PathPrefix(`/admin`))"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
      # watchtower
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      - ALLOWED_ORIGINS=https://cartera.heavycream.es,http://backend:8800
      - DJANGO_SUPERUSER_USERNAME=admin
      - DJANGO_SUPERUSER_EMAIL=heavycream9090@icloud.com
      - DJANGO_SETTINGS_DEBUG_MODE=False
      - SERVER_ADDRESS=0.0.0.0
      - SERVER_PORT=8000
      - POSTGRES_DB_HOST=postgres
      - POSTGRES_DB_NAME=wallet
      - POSTGRES_DB_USER=main
      - POSTGRES_DB_PORT=5432
      - FRONTEND_URL=https://cartera.heavycream.es
      # secrets
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
      - SECRET_KEY=${SECRET_KEY}
      - DJANGO_SUPERUSER_PASSWORD=${DJANGO_SUPERUSER_PASSWORD}
      - POSTGRES_DB_PASSWORD=${POSTGRES_DB_PASSWORD}
    depends_on:
      - postgres
    restart: on-failure
    volumes:
      - file_server_data.staticfiles:/home/wallet_app/app/staticfiles
      - file_server_data.images:/home/wallet_app/app/media
    networks:
      - ext

  frontend:
    image: pavelbeard/wallet-frontend.production:latest
    labels:
      # loadbalancer
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`cartera.heavycream.es`) && (PathPrefix(`/`) || PathPrefix(`/api`))"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      # watchtower
      - "com.centurylinklabs.watchtower.enable=true"
    environment:
      - NEXT_API_URL=http://backend:8800
      - NEXTAUTH_URL=http://cartera.heavycream.es
      - STATIC_PATH=http://cartera.heavycream.es
      # secrets
      - AUTH_SECRET=${SECRET_KEY}
      - AUTH_GOOGLE_ID=${AUTH_GOOGLE_ID}
      - AUTH_GOOGLE_SECRET=${AUTH_GOOGLE_SECRET}
    restart: on-failure
    depends_on:
      - backend
    networks:
      - ext

  file_server:
    image: pavelbeard/wallet-file-server.production:latest
    labels:
      # loadbalancer
      - "traefik.enable=true"
      - "traefik.http.routers.file_server.rule=Host(`cartera.heavycream.es`) && (PathPrefix(`/backend/static`) || PathPrefix(`/backend/media`))"
      # watchtower
      - "com.centurylinklabs.watchtower.enable=true"
    restart: on-failure
    volumes:
      - file_server_data.staticfiles:/home/wallet_app/app/staticfiles
      - file_server_data.images:/home/wallet_app/app/media
    networks:
      - ext

volumes:
  letsencrypt:
  postgresdata:
  file_server_data.staticfiles:
  file_server_data.images:

networks:
  ext:
    external: true